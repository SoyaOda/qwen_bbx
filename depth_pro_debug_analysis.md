# Depth Pro デバッグ分析レポート

## 実行結果サマリー
- **実行日時**: 2025年9月11日
- **対象画像**: train_00000.jpg（ご飯）
- **深度推定モデル**: Apple Depth Pro
- **計算された体積**: 6.4 mL（期待値: 100-300 mL）

---

## 質問1: 平均高さが0.0mmになる理由

### コードからの明示的な証拠

**はい、コードから明確に理由が分かります。**

#### 1. 数値的証拠
```
マスク内の高さマップ分析:
- ゼロピクセル: 71005 / 71635 (99.1%)
- 正のピクセル: 630 / 71635 (0.9%)
- 正の値の統計: 平均=4.68mm, 中央値=4.07mm
```

#### 2. コード上の処理（2段階の問題）

**第1段階: 平面推定の失敗**
- 推定された平面の法線: `[0.014, 0.413, 0.910]`
- 水平からの傾き: **24.4度**
- 本来のテーブル面は水平（法線≈[0,0,1]）であるべき

**第2段階: 負の高さのクリッピング**
```python
# src/volume_depthpro.py の height_from_plane関数
if clip_negative:
    height[height < 0] = 0.0  # 負の値を全て0に強制
```

#### 3. 視覚的証拠（height_map.png）
- **左図（Full）**: 画像右上のみに高い値（黄緑〜シアン）が見える
- **右図（Masked）**: マスク内はほぼ全て濃紺（0mm付近）
- 統計表示: Mean: 0.04mm, Median: 0.00mm

### 結論
斜めの平面を基準にしたため、ご飯の99.1%が「平面より下」と判定され、`clip_negative=True`により0にクリップされた。これが平均高さ≈0.0mmの直接的原因。

---

## 質問2: マスク画像の精度評価

### マスクの統計情報
```
マスク分析:
- 画像サイズ: 512×384
- マスクピクセル: 71,635 (全体の36.4%)
- 外接矩形: (158,43) - (512,343), サイズ: 354×300
- 充填率: 67.5%
```

### 視覚的評価（train_00000_det00_rice_bplus_overlay.jpg）
オーバーレイ画像を確認すると：
- **緑色の半透明領域**がご飯の部分を正確に覆っている
- エッジは適切に検出されている
- 過度な余白は含まれていない
- ご飯の形状（楕円形）を適切に捉えている

### 評価結果
**マスクは高精度で、体積が小さい原因ではありません。**
- 充填率67.5%は、楕円形のご飯として妥当
- マスクの品質は良好で、SAM2の性能を示している
- **体積誤差の原因は平面推定の失敗**であり、マスクの問題ではない

---

## 質問3: 可視化ファイルの出力状況

### 出力成功したファイル

#### 1. 画像ファイル
| ファイル名 | 内容 | 状態 |
|-----------|------|------|
| `depth_map.png` | 深度マップ（viridisカラーマップ） | ✅ 正常出力 |
| `height_map.png` | 高さマップ（全体＋マスク内） | ✅ 正常出力 |
| `train_00000_det00_rice_bplus_overlay.jpg` | マスクオーバーレイ | ✅ 正常出力 |

#### 2. PLYファイル（3D点群）
| ファイル名 | 内容 | 状態 |
|-----------|------|------|
| `pointcloud_all.ply` | 全体の3D点群（高さで色分け） | ✅ 正常出力 |
| `pointcloud_masked.ply` | マスク内のみの点群 | ✅ 正常出力 |
| `plane.ply` | 推定された平面の可視化 | ✅ 正常出力 |

### 深度マップの観察（depth_map.png）
- **範囲**: 0.431m - 1.235m
- **中央値**: 0.605m
- **特徴**: 
  - 左下（紫）: 手前の皿やテーブル（近い）
  - 右上（黄緑）: 背景（遠い）
  - 中央部: ご飯の領域は均一な青〜青緑

### 高さマップの観察（height_map.png）
- **左図（Full）**: ほぼ全体が0mm（濃紺）、右上角のみ高い値
- **右図（Masked）**: ご飯領域内もほぼ0mm
- **問題点**: 本来10-30mm程度の高さがあるべきご飯が、ほぼ0mmと計算されている

### PLYファイルの確認方法
```bash
# ファイルサイズ確認
ls -lh debug_output/*.ply

# MeshLabで開く
meshlab debug_output/pointcloud_all.ply

# CloudCompareで開く
cloudcompare debug_output/pointcloud_masked.ply
```

---

## 根本原因の診断

### 問題の核心
**平面推定アルゴリズムがテーブル面を正しく検出できていない**

1. **現在の推定**: 24.4度傾いた斜面
2. **期待される推定**: 水平面（傾き<5度）
3. **影響**: ご飯の99%以上が「テーブル下」と誤判定

### 推定失敗の原因
- リング領域に背景の傾斜部分が含まれている
- RANSACが最大インライア数の平面を選択した結果、誤った面を採用
- 水平性制約（15度）が緩すぎる

### 改善提案
1. **深度ヒストグラムのピーク付近の点のみを使用**
2. **マスクをエロージョン**して縁を確実に除外
3. **水平性制約を5度以内に厳格化**
4. **深度の中央値付近（±10cm）の点のみでRANSAC**

---

## 結論

1. **平均高さ0.0mmの原因**: 斜めの平面推定により99.1%のピクセルが負となり、`clip_negative=True`で0にクリップされた
2. **マスク精度**: 高精度で問題なし（充填率67.5%は妥当）
3. **可視化出力**: 全ファイル正常に出力済み（6つの画像/PLYファイル）

**最優先の改善点**: 平面推定アルゴリズムの修正
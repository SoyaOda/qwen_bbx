# UniDepth v2 実装検証結果と推奨事項

## 検証結果サマリー

### 主要な発見事項

1. **UniDepthの推定Kは実際には小さすぎる**
   - UniDepth推定: fx ≈ 686（画像幅512px）
   - 現実的な体積に必要: fx ≈ 10,500
   - **必要なスケールファクター: 約10.5倍**

2. **K_scale_factorは必要だが、固定値ではなく適応的にすべき**
   - 画像解像度やFOVに依存
   - 食事撮影の典型的条件から動的に計算

3. **その他の改良は有効**
   - 正しい逆投影式（K^{-1}使用）✓
   - a_pix = Z²/(fx·fy) の式は正しい ✓
   - 符号決定ロジックの改善 ✓
   - スケール依存のRANSAC閾値 ✓

## 技術的詳細

### 体積計算の検証結果

| Kの設定 | fx値 | 体積結果 | 評価 |
|---------|------|---------|------|
| UniDepth推定（そのまま） | 686 | 46L | ✗ 大きすぎる |
| FOV 50° | 549 | 76L | ✗ 大きすぎる |
| FOV 60° | 443 | 121L | ✗ 大きすぎる |
| FOV 70° | 366 | 182L | ✗ 大きすぎる |
| 食事撮影典型 | 427 | 131L | ✗ 大きすぎる |
| **最適値（逆算）** | **10,500** | **200mL** | **✓ 現実的** |

### 根本原因

UniDepth v2は以下の理由でKを過小推定している可能性：

1. **学習データのバイアス**
   - 広角/風景画像中心の学習
   - 近接撮影（食事など）のデータ不足

2. **メトリック深度の曖昧性**
   - 深度の絶対値は正しいが、スケールファクターが必要
   - カメラモデルの推定が不完全

## 推奨実装方針

### 1. 実用的解決策（短期）

```python
# config.yaml
unidepth:
  K_scale_factor: 10.5  # 食事撮影用の固定値
  # または
  K_estimation_mode: "food_photography"  # 自動調整
```

### 2. 適応的解決策（中期）

```python
def estimate_K_for_food_photography(depth, image_shape):
    """食事撮影に適したKを推定"""
    H, W = image_shape
    
    # 典型的な条件
    # - 撮影距離: 40-60cm
    # - 皿の直径: 20-25cm
    # - 画像内での皿の占有率: 30-50%
    
    median_depth = np.median(depth)
    
    # 経験的な式
    if median_depth < 0.8:  # 近接撮影
        scale_factor = 15.0
    elif median_depth < 1.5:  # 標準的な食事撮影
        scale_factor = 10.5
    else:  # 遠距離
        scale_factor = 6.0
    
    return scale_factor
```

### 3. キャリブレーションベース（長期）

```python
def calibrate_with_known_object():
    """既知サイズの物体（A4紙など）でキャリブレーション"""
    # 初回セットアップ時に実行
    # A4紙（297x210mm）を撮影
    # 正確なKを計算して保存
```

## 実装の優先順位

1. **即座に適用すべき**
   - K_scale_factor = 10.5 を設定（食事撮影用）
   - Sanity checkの常時出力

2. **次のステップ**
   - 深度に基づく適応的スケーリング
   - EXIFデータの活用（可能な場合）

3. **将来的な改善**
   - ユーザーキャリブレーション機能
   - 複数の既知物体での検証

## 結論

レビューで指摘された通り、UniDepthの推定Kをそのまま使うと体積が異常になります。
ただし、**K_scale_factorの撤廃は現実的ではなく**、以下のアプローチが推奨されます：

1. **固定スケーリング（K_scale_factor = 10.5）を維持**
2. **将来的には適応的スケーリングに移行**
3. **キャリブレーション機能の追加**

### 重要な注意事項

- ImageNet正規化の有無は体積に大きく影響しない（0.8倍程度）
- 逆投影式とa_pixの計算は理論的に正しい
- 問題の本質はUniDepthのK推定の不正確さ

## 参考文献

- UniDepth README: モデルの使用方法
- ピンホールカメラモデル: a_pix = Z²/(fx·fy)の導出
- 食事撮影の典型的条件: 距離40-60cm、FOV 50-70°
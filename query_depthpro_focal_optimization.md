# Depth Pro 焦点距離推定の最適化に関する技術的調査

## 現状の問題

Apple Depth Proを使用した食品体積推定システムにおいて、体積が期待値の約60倍（11.68L vs 期待値200mL）になる問題が発生しています。

## 現在の実装詳細

### 1. Depth Pro統合実装 (depthpro_runner.py)
```python
def infer_image(self, image_path: str):
    # 画像読み込み (512x384)
    img_pil = Image.open(image_path).convert("RGB")
    
    # EXIFから35mm換算焦点距離を取得
    f35 = read_f35_from_exif(img_pil)  # → None (テスト画像にEXIFなし)
    
    # 35mm換算からfx, fyを計算（fx = W * f35/36, fy = H * f35/24）
    if f35:
        fx, fy = fx_fy_from_f35(W, H, f35)
        f_px_for_model = fx
    else:
        f_px_for_model = None  # モデル推定にフォールバック
    
    # Depth Pro推論
    prediction = self.model.infer(image_tensor, f_px=f_px_for_model)
    
    # モデル予測の焦点距離を使用（EXIFがない場合）
    fpx_pred = prediction["focallength_px"]  # → 531.3 pixels
    fx = fpx_pred
    fy = fx * (H / W)  # → 398.5 pixels
```

### 2. 体積計算アルゴリズム
```python
# 画素面積計算
a_pix = depth^2 / (fx * fy)  # 現在: 1.729 mm²/pixel

# 体積積分
volume = Σ(height[mask] * a_pix[mask])
```

## 観測された値

### テスト実行結果（train_00000.jpg: ご飯）
- **画像サイズ**: 512x384 pixels
- **深度範囲**: 0.431m - 1.235m（中央値: 0.605m）
- **モデル予測焦点距離**: fx=531.3px, fy=398.5px
- **画素面積**: 1.729 mm²/pixel
- **マスクピクセル数**: 71,635
- **計算された体積**: 11,680.2 mL（11.68L）
- **期待される体積**: 100-300 mL

### 問題の核心
1. **焦点距離が過小**: fx=531pxは512px幅に対して広角（FOV≈53°）
2. **画素面積が過大**: 1.729mm²は実際の料理撮影には大きすぎる
3. **結果**: 体積が約60倍に膨張

## 比較データ

### UniDepth v2での結果（同じ画像）
- 体積: 126.9 mL（K_scale=5.0補正後）
- 焦点距離: 約2500-3000px相当（K_scale補正前）

### 理論的に妥当な値
- 一般的なスマートフォン撮影: fx≈1000-1500px（512px幅に対して）
- 期待される画素面積: 0.1-0.3 mm²/pixel
- 期待されるFOV: 25-35°（料理撮影の典型的な値）

## Depth Proの仕様（公式ドキュメントより）

1. **絶対スケール推定**: カメラ内部パラメータなしでメートル単位の深度を直接推定
2. **焦点距離推定**: FOVヘッドによる自動推定、またはf_px引数での明示的指定
3. **内部処理**: 1536x1536にリサイズ→推論→元解像度に再拡大
4. **f_pxの意味**: 入力テンソル幅Wに対応する横方向の焦点距離[pixels]

## 調査が必要な技術的ポイント

1. **Depth ProのFOVヘッドの精度**
   - 食品のクローズアップ画像に対する推定精度
   - 訓練データセットのバイアス（広角画像が多い？）

2. **焦点距離の適切なデフォルト値**
   - 料理撮影に最適な仮定値
   - 画像の内容から推定する方法

3. **代替アプローチ**
   - 既知サイズの参照物体を使った較正
   - 複数フレームからの推定
   - ユーザーによる撮影距離の入力

4. **Depth Proの最新バージョン/パッチ**
   - FOV推定の改善
   - 食品・クローズアップ画像への対応

## 質問

1. Depth ProのFOVヘッドが食品クローズアップ画像で過小な焦点距離を推定する問題の回避方法は？
2. EXIFデータがない場合の、画像内容に基づく焦点距離推定のベストプラクティスは？
3. Depth Proの公式実装で、特定のドメイン（食品撮影）に最適化する方法はあるか？
4. 焦点距離を手動で調整する場合の、適切な値の範囲と決定方法は？

これらについて、公式実装を参考にした解決策を教えてください。